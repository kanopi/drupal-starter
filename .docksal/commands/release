#!/usr/bin/env bash

## Make a new release and deploys it.
##
## Usage: fin release

# Abort if anything fails
set -e

# Backup the environments.
fin terminus backup:create ${hostingsite}.dev --keep-for=365
fin terminus backup:create ${hostingsite}.test --keep-for=365
fin terminus backup:create ${hostingsite}.live --keep-for=365

# Create a new tag
var_release_previous=$(gh release view)
if [ -z "$var_release_previous" ]; then
    var_tag_new=0.0.1
else
    var_tag_new=$(git describe --tags --abbrev=0 | awk -F. '{OFS="."; $NF+=1; print $0}')
fi

echo -e "Creating a new tag."
git tag -a $var_tag_new -m "Autogenerated deployment release tag"

echo -e "Push new tag."
git push origin $var_tag_new

echo -e "Create new release"
gh release create $var_tag_new --generate-notes

# Get the release notes, URL, and Name.
var_release_notes=$(gh release view $var_tag_new --json body --jq .body | cat)
var_release_url=$(gh release view $var_tag_new --json url --jq .url | cat)
var_release_tag=$(gh release view $var_tag_new --json tagName --jq .tagName | cat)

# Deploy to Test
# fin terminus env:deploy --sync-content --note $var_release_notes --cc --updatedb -- ${hostingplatform}.test

# Deploy to Live
prod_release_command='fin terminus env:deploy --note $var_release_notes --cc --updatedb -- ${hostingplatform}.live'
echo -e "Once you have thoroughly tested the ${hostingplatform}.test environment, you can deploy to live using the following command"
echo -e "$prod_release_command"

# Post release notes and release URL to Slack.
# @TODO Print these variable Title: $var_release_tag Body: $var_release_notes Link: $var_release_url, 
# @TODO actually post it.
